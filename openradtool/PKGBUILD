# Maintainer: Adrian Perez de Castro <aperez@igalia.com>
pkgname=openradtool
pkgdesc='Generator for front-end and back-end code for Web applications written in C'
pkgver=0.14.1
pkgrel=2
url=https://kristaps.bsd.lv/openradtool
license=(custom:BSD)
makedepends=(bc bmake)
depends=(expat)
conflicts=(kwebapp)
replaces=(kwebapp)
optdepends=('sqlbox: Needed by code generated by openradtool')
arch=('x86_64')
source=("${url}/snapshots/openradtool-${pkgver}.tar.gz" makefile-ldflags.patch)
b2sums=('3c23167aed36ad1e86c28a67e570f74d539f08b107bec9082cee490a3a4aa14c621f5847f031b24e25e8197be13eed4b7c4c381974b90610823bd023f648c276'
        '26b4baa33c8722026555f5d4896449e108c87bce8bcc9ef2db13fde4ec5143c21e57b3d22e097d472654b1fd3839c34662105f0c307148dcdcfba86014eb22bd')

prepare () {
	cd "${pkgname}-${pkgver}"
	patch -p1 < "${srcdir}/makefile-ldflags.patch"
}

build () {
	cd "${pkgname}-${pkgver}"
	CFLAGS="${CFLAGS}" ./configure PREFIX=/usr MANDIR=/usr/share/man LDFLAGS="${LDFLAGS}"
	chmod +w ort-version.h
	bmake MAKE=bmake
}

check () {
	bmake -C "${pkgname}-${pkgver}" -j1 regress MAKE=bmake
}

package () {
	cd "${pkgname}-${pkgver}"
	bmake install DESTDIR="${pkgdir}" MAKE=bmake
	strip -x --strip-unneeded "${pkgdir}"/usr/bin/ort*
	awk '/^\/\*/,/\*\// { print ; }' main.c > COPYING
	install -Dm644 COPYING "${pkgdir}/usr/share/licenses/${pkgname}/COPYING"
}
