# Maintainer: Daniel Serrano Armenta <anabasasoft@gmail.com>
pkgname=sentinelx
pkgver=1.4.5
pkgrel=1
pkgdesc="Tu Guardi치n de Red para Linux. Simple. Potente. Inteligente. (Compila desde fuente)"
arch=('x86_64')
url="https://github.com/AnabasaSoft/SentinelX"
license=('LGPL3')
provides=('sentinelx')
conflicts=('sentinelx' 'sentinelx-bin')

# Dependencias para EJECUTAR
depends=('python' 'polkit' 'clamav' 'hicolor-icon-theme')

# Dependencias necesarias solo para COMPILAR (Build)
makedepends=('git' 'python-pip' 'python-setuptools' 'base-devel')

# Descargamos el c칩digo fuente exacto de la versi칩n
source=("git+https://github.com/AnabasaSoft/SentinelX.git#tag=v${pkgver}")
sha256sums=('5cdf4c42b8e4a8e5f2562213568fbf34ebafd1f9ba75e9b0243c91a03ea6b07f')

build() {
    cd "SentinelX"

    echo "游닍 Creando entorno virtual temporal..."
    python -m venv venv
    source venv/bin/activate

    echo "拘勇 Instalando dependencias..."
    pip install --upgrade pip
    pip install -r requirements.txt
    pip install pyinstaller

    echo "游댣 Compilando binario..."
    # Usamos --onedir para que sea m치s r치pido de arrancar en sistema
    pyinstaller --noconfirm \
        --onedir \
        --windowed \
        --name "SentinelX" \
        --add-data "SentinelX-Icon-512.png:." \
        --add-data "lang:lang" \
        --hidden-import "PySide6" \
        SentinelX.py
}

package() {
    cd "SentinelX"

    echo "游늭 Instalando archivos en el sistema..."

    # 1. Copiar la carpeta compilada a /opt
    install -dm755 "${pkgdir}/opt/${pkgname}"
    cp -r "dist/SentinelX/"* "${pkgdir}/opt/${pkgname}/"

    # 2. Enlace simb칩lico
    install -dm755 "${pkgdir}/usr/bin"
    ln -s "/opt/${pkgname}/SentinelX" "${pkgdir}/usr/bin/${pkgname}"

    # 3. Icono
    install -Dm644 "SentinelX-Icon-512.png" "${pkgdir}/usr/share/icons/hicolor/512x512/apps/${pkgname}.png"

    # 4. Desktop Entry
    install -dm755 "${pkgdir}/usr/share/applications"
    cat << EOF > "${pkgdir}/usr/share/applications/${pkgname}.desktop"
[Desktop Entry]
Name=SentinelX
Comment=Tu Guardi치n de Red para Linux
Exec=/usr/bin/${pkgname}
Icon=${pkgname}
Type=Application
Categories=System;Security;Network;
Terminal=false
EOF

    # 5. Instalar licencia
    install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
