# PKGBUILD generated by pipman
# Python package author: Luxonis <support@luxonis.com>
# AUR package author : Robin Trioux <robin@trioux.eu>

pkgname=python-depthai
pkgver=2.30.0.0
pkgrel=1
pkgdesc="DepthAI Python Library"
arch=('x86_64')
url="https://github.com/luxonis/depthai-python"
license=(MIT)
makedepends=("python" "python-build" "python-installer" "gcc-libs" "glibc" "curl" "sed" "cmake>3.5")
depends=("python" "libusb")
optdepends=("mypy" "python-pyqt5" "python-psutil" "python-numpy" "python-opencv")
options+=(!strip)

core_version=$(echo "$pkgver" | sed 's/\.[^.]*$//') # Stripping last version number as it does not exist for depthai core
source=(
dephtai-python-$pkgver.tar.gz::"https://github.com/luxonis/depthai-python/archive/refs/tags/v$pkgver.tar.gz"
depthai-core-$core_version.tar.gz::"https://github.com/luxonis/depthai-core/releases/download/v$core_version/depthai-core-v$core_version.tar.gz"
"80-movidius.rules"
"pyproject.toml"
)

prepare() {
	cd "$srcdir"
	cp -f pyproject.toml depthai-python-$pkgver
	cp -r depthai-core-v$core_version/* depthai-python-$pkgver/depthai-core/
}


build() {
	# Prevent hunter C++ package manager from using users home
	#export HUNTER_ROOT=$srcdir/hunter
	#export HUNTER_BINARY_DIR=$srcdir/hunterdir
	#mkdir -p $HUNTER_ROOT
	#mkdir -p $HUNTER_BINARY_DIR
	export CMAKE_MINIMUM_REQUIRED_VERSION=3.5
	export CMAKE_POLICY_VERSION_MINIMUM=3.5
	ncpu=$(nproc --all)
	export MAKEFLAGS="-j$ncpu"
	cd $srcdir/depthai-python-$pkgver
	python -m build --wheel --no-isolation
}

package() {
	cd $srcdir/depthai-python-$pkgver
	python -m installer --destdir="$pkgdir" dist/*.whl
	install -Dm644 "${srcdir}/80-movidius.rules" "$pkgdir/etc/udev/rules.d/80-movidius.rules"
	install -Dm644 "${srcdir}/depthai-python-$pkgver/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
	sudo udevadm control --reload-rules && sudo udevadm trigger
}

sha256sums=('f11d82815c02f217b83064153036e2664c11ef09465f660d4cb527c14ef2a0e5'
            '73b4f079b987a1e330ae8c7f7c23a799fe9d0171ae77996571eeb50468bd04ef'
            '06643091a944b1e562f8ba5ecf8011b473120c6256ba2a2ac9b85fe8c1bb30aa'
            'a0b59fa6f09767cce0e5bd1f5097db4381a9ecb119304113fe0533db5c7e52b5')
