# Maintainer: Moses Narrow <moe_narrow@use.startmail.com>
pkgname=nex
pkgname1=nex
pkgdesc="Lexer for Go http://cs.stanford.edu/~blynn/nex/"
pkgver='autogenerated'
pkgrel=1
arch=('any')
pkggopath="github.com/blynn/${pkgname}"
url="https://${pkggopath}"
license=()
depends=(go)
source=("git+${url}.git")
#actually the source is fetched with go get
sha256sums=('SKIP')

case "$CARCH" in
x86)      export GOARCH="386" GO386="387" ;;
x86_64)   export GOARCH="amd64" ;;
arm*)     export GOARCH="arm" ;;
armel)    export GOARCH="arm" GOARM="5" ;;
armhf)    export GOARCH="arm" GOARM="6" ;;
armv7)    export GOARCH="arm" GOARM="7" ;;
armv8)    export GOARCH="arm64" ;;
aarch64)  export GOARCH="arm64" ;;
mips)     export GOARCH="mips" ;;
mips64)   export GOARCH="mips64" ;;
mips64el) export GOARCH="mips64le" ;;
mipsel)   export GOARCH="mipsle" ;;
*)        return 1 ;;
	esac

	pkgver() {
	cd "${srcdir}/${pkgname1}"
	local date=$(git log -1 --format="%cd" --date=short | sed s/-//g)
	local count=$(git rev-list --count HEAD)
	local commit=$(git rev-parse --short HEAD)
	echo "${date}.${count}_${commit}"
	}

build() {
  mkdir -p ${srcdir}/go
  export GOPATH=${srcdir}/go #${srcdir}/${pkgname}
  export GOBIN=${srcdir}/go
  cd ${srcdir}/go
  go get ${pkggopath}
}

package() {
#create dir structure
mkdir -p ${pkgdir}/usr/bin/
mkdir -p ${pkgdir}/usr/lib/${pkgname}/bin/
#putting the sources in /usr/lib/nbxplorer
cp -b $srcdir/go/${pkgname} ${pkgdir}/usr/lib/${pkgname}/bin/${pkgname}
#symlinking run.sh to /usr/bin/nbxplorer
ln -rTsf ${pkgdir}/usr/lib/${pkgname}/bin/${pkgname} ${pkgdir}/usr/bin/${pkgname}
chmod 755 ${pkgdir}/usr/bin/${pkgname}
cp -r ${srcdir}/${pkgname}/ ${pkgdir}/usr/lib/${pkgname}/
}
